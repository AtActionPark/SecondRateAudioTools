(function(){InadequateVisualizer=function(a){this.context=a.context?a.context:new AudioContext,this.divID=a.divID||'defaultInadequateVisualizerID',this.type=a.type||'Oscilloscope',this.WIDTH=a.width||400,this.HEIGHT=a.height||220,this.fftSize=a.fftSize||2048,this.panelSize=a.panelSize||100,this.topSize=a.topSize||20,this.bottomSize=a.bottomSize||20,this.leftSize=a.leftSize||20,this.panelColor=a.panelColor||'rgb(15, 15, 15)',this.panelTextColor=a.panelTextColor||'rgb(0, 200, 0)',this.backgroundColor=a.backgroundColor||'rgba(0, 40, 0, 0.5)',this.strokeStyle=a.strokeStyle||'rgb(0, 200, 0)',this.fillStyle=a.fillStyle||'rgb(0, 200, 0)',this.params={yScaleVolume:1,xScaleVolume:200,maxXScaleVolume:400,precisionVolume:2,yScaleFrequencies:10,nbOfBarsFrequencies:50,xScaleFrequencies:1,yScaleOscilloscope:50,xScaleOscilloscope:50},this.analyser,this.canvasCtx,this.dataArray,this.bufferLength,this.frameCount=0,this.volumeArray=[],this.panel,this.width=this.WIDTH-this.panelSize-this.leftSize,this.height=this.HEIGHT-this.topSize-this.bottomSize,this.freqAxisLegend='Axis:1000Hz / tick',this.freeze=!1,this.maxNbOfBars=0,this.init()},InadequateVisualizer.prototype.connectAndDraw=function(a,b){a.connect(this.analyser),b&&this.analyser.connect(b),this.draw()},InadequateVisualizer.prototype.init=function(){this.analyser=this.context.createAnalyser(),this.analyser.fftSize=this.fftSize,this.analyser.smoothingTimeConstant=0.3,this.bufferLength=this.analyser.frequencyBinCount,this.maxNbOfBars=Math.min(this.width/2,this.bufferLength);let a=document.getElementById(this.divID);if(null==a){let l=document.createElement('div');l.id='defaultInadequateVisualizerID',document.body.appendChild(l),a=document.getElementById(l.id)}a.style.height=this.HEIGHT+'px',a.style.width=this.WIDTH+'px',a.style.display='inline-block',a.style.border='1px solid black',a.style.backgroundColor=this.panelColor,a.style.position='relative',a.classList.add('inadequateVisualizer');let b=document.createElement('div');b.style.position='absolute',b.style.width=this.width+'px',b.style.textAlign='center',b.style.margin='auto',b.style.color=this.panelTextColor;let c=document.createElement('b');c.innerHTML=this.type,b.appendChild(c);let e=document.createElement('div');e.style.position='absolute',e.style.top='0px',e.style.width=this.leftSize+'px',e.style.height=this.HEIGHT+'px',e.style.color=this.panelTextColor;let f=document.createElement('div');f.style.position='absolute',f.style.bottom='0px',f.style.width=this.width+'px',f.style.color=this.panelTextColor,f.innerHTML='Frequency'==this.type?this.freqAxisLegend:'',a.appendChild(b),a.appendChild(e),a.appendChild(f);let g=document.createElement('canvas');this.canvasCtx=g.getContext('2d'),g.width=this.width,g.height=this.height,g.style.cssText='position:absolute;top:'+this.topSize+'px;left:'+this.leftSize+'px;',a.appendChild(g);let k=document.createElement('div');k.id=this.divID+'Panel',k.classList.add('panel'),k.style.display='inline-block',k.style.position='absolute',k.style.right='0px',k.style.width=this.panelSize+'px',k.style.height=this.HEIGHT+'px',a.appendChild(k),this.addControls(k)},InadequateVisualizer.prototype.draw=function(){if(!this.freeze){requestAnimationFrame(InadequateVisualizer.prototype.draw.bind(this));this.dataArray=new Uint8Array(this.bufferLength),this.canvasCtx.fillStyle=this.backgroundColor,this.canvasCtx.fillRect(0,0,this.WIDTH,this.HEIGHT),this.canvasCtx.lineWidth=2,this.canvasCtx.strokeStyle=this.strokeStyle,this.canvasCtx.beginPath(),'Volume'==this.type?this.drawVolume():'Frequency'==this.type?this.drawFrequencies():'Oscilloscope'==this.type&&this.drawOscilloscope()}},InadequateVisualizer.prototype.addControls=function(){let b=this,c=document.getElementById(this.divID+'Panel'),e=this.HEIGHT/10,f=(this.HEIGHT-e)/3,g=document.createElement('button');g.id=this.type+'Freeze',g.innerHTML='Freeze',g.style.position='absolute',g.style.left='10px',g.style.top=e/2+3*f-20+'px',g.onclick=function(){b.freeze=!b.freeze,b.draw()},c.appendChild(g),'Volume'==this.type&&(c.appendChild(this.addControl('yScale','yScaleVolume',e/2,1,10)),c.appendChild(this.addControl('Memory','xScaleVolume',e/2+f,3,this.params.maxXScaleVolume))),'Frequency'==this.type&&(c.appendChild(this.addControl('Resolution','nbOfBarsFrequencies',e/2,4,this.maxNbOfBars)),c.appendChild(this.addControl('Zoom','xScaleFrequencies',e/2+f,1,10))),'Oscilloscope'==this.type&&(c.appendChild(this.addControl('yScale','yScaleOscilloscope',e/2,1,200)),c.appendChild(this.addControl('Zoom','xScaleOscilloscope',e/2+f,1,100)))},InadequateVisualizer.prototype.addControl=function(a,b,c,e,f){let g=this,k=document.createElement('div');k.style.position='absolute',k.style.top=c+'px';let l=document.createElement('p');l.innerHTML=a,l.style.position='absolute',l.style.left='5px',l.style.margin=0,l.style.padding=0,l.style.color=this.panelTextColor,k.appendChild(l);let m=document.createElement('input');return m.id=a+'Slider',m.classList.add('slider'),m.style.position='absolute',m.style.left='5px',m.style.top='15px',m.style.width=this.panelSize-10+'px',m.type='range',m.min=e,m.max=f,m.step=1,m.value=g.params[b],m.onchange=function(){g.params[b]=this.value,'xScaleVolume'==b&&(g.volumeArray=g.volumeArray.slice(0,g.params[b]))},k.appendChild(m),k},InadequateVisualizer.prototype.drawVolume=function(){this.analyser.getByteFrequencyData(this.dataArray);let a=this.getAverageVolume(this.dataArray),b=this.height-this.height*this.params.yScaleVolume*a/100,c=this.params.xScaleVolume;this.frameCount++,this.frameCount>=this.params.precisionVolume&&(this.frameCount=0,this.volumeArray.push(b),this.volumeArray.length>c&&this.volumeArray.shift()),this.canvasCtx.moveTo(0,this.height/2);for(let e=1;e<c;e++)this.canvasCtx.moveTo((e-1)*this.width/c,this.volumeArray[e-1]),this.canvasCtx.lineTo(e*this.width/c,this.volumeArray[e]);this.canvasCtx.stroke()},InadequateVisualizer.prototype.drawFrequencies=function(){this.analyser.getByteFrequencyData(this.dataArray);let a=this.params.nbOfBarsFrequencies,b=this.params.xScaleFrequencies,c=this.width/a,e,f=0,g=Math.ceil(this.bufferLength/(a*b)),k=Math.max.apply(null,this.dataArray),l=0,m=[];for(let n=0;n<a;n++){e=0;for(let o=0;o<g;o++)e+=this.dataArray[n*g+o];e/=g,e>l&&(l=e),m.push(e)}for(let o,n=0;n<a;n++)o=0.85*this.height*m[n]/255,o*=k/l,this.canvasCtx.fillStyle=this.fillStyle,this.canvasCtx.fillRect(f,this.height-10-o,c,o),f+=c+1;this.canvasCtx.font='12px Arial';for(let n=1e3;n<this.context.sampleRate/2;n+=1e3)this.canvasCtx.fillText('|',(c+1)*this.getIndexFromFrequencies(n,g)-c/2,this.height)},InadequateVisualizer.prototype.drawOscilloscope=function(){this.analyser.getByteTimeDomainData(this.dataArray);let a=0;for(let e=0;e<this.fftSize-this.width;e++)if(128>=this.dataArray[e]&&128<this.dataArray[e+1]){a=e;break}let b=0,c=Math.round(10*this.fftSize/(2*this.width))/10;for(let e=0;b<this.width;e++){b+=this.params.xScaleOscilloscope/50,e>this.bufferLength&&(e-=this.bufferLength);const f=this.params.yScaleOscilloscope/50*(this.dataArray[e+a]-128)/256*this.height+this.height/2;0===e?this.canvasCtx.moveTo(b,f):this.canvasCtx.lineTo(b,f)}this.canvasCtx.stroke()},InadequateVisualizer.prototype.getAverageVolume=function(a){let c,b=0,e=a.length;for(let f=0;f<e;f++)b+=a[f]/255*a[f]/255;return c=100*Math.sqrt(b/e*(2048/this.fftSize)),c},InadequateVisualizer.prototype.getIndexFromFrequencies=function(a,b){let c=this.context.sampleRate/this.fftSize;return c*=b,a/c}})();